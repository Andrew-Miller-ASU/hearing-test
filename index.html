<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hearing Test</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="container">
    <h1>Online Hearing Test</h1>
    <div id="calibration-page">
        <p style="margin-bottom:12px; text-align: left;">Welcome to the Online Hearing Test! First, let's ensure your audio devices are properly calibrated to your preferences. Click the "Test Volume" button below for the controls to play a sound. If you can hear the sound and it is an appropriate volume for you, click "Proceed To Test". Otherwise, please adjust your volume accordingly.</p>
        <button onclick="calibrationTest()">Test Volume</button>
        <button onclick="proceedToTest()">Proceed To Test</button>
        <audio id="calibrationTestAudio" style="display: none;" controls></audio><br>
    </div>
    <div id="mode-select" style="display: none;">
       <h2>Choose Your Test Mode</h2>
       <button onclick="startTest('both')">ðŸ”Š No Headphones</button>
       <button onclick="startTest('headphones')">ðŸŽ§ Headphones (Left & Right)</button>
       <button onclick="startDbHlTest()">dB HL Testing</button>
       <button onclick="startDINTest()">Digit-In-Noise Testing</button>
    </div>
    <div id="DIN_Test_Area" style="display: none;">
        <h2>Digit-In-Noise Test</h2>
        <p style="margin-bottom:12px; text-align:left;">The Digits-in-Noise Test will measure your ability to discern speech in the presence of background noise.</p>
        <p style="margin-bottom:12px; text-align:left;">Click "Play" to listen to the audio, then enter the digits you heard and click "Submit" to check your accuracy.</p>
        <p id="DIN_Test_Round_Display">Round 1/20</p>
        <div style="display:flex; justify-content:center; margin-top:20px; margin-bottom:20px;">
            <button id="din-play-button">Play</button>
        </div>
        <input id="DIN_User_Input" type="text"
            inputmode="numeric"
            pattern="[0-9]{3}"
            maxlength="3"
            style="
            font-size:64px;
            font-family:monospace;
            text-align:center;
            border:3px solid #cbd5e1;
            border-radius:10px;
            padding:8px;
            padding-left:calc(8px + 1ch);
            width:6ch;
            letter-spacing:1ch;
            "
        />
        <div style="display:flex; justify-content:center; margin-top:20px; margin-bottom:20px;">
            <button id="DIN_Test_enter_button">Submit</button>
            <button id="quit_DIN_Test_Button">Quit</button>
        </div>
        <br />
        <audio id="DINTestAudio" style="display: none;" controls></audio>
    </div>
    <div id="DIN_Results_Area" style="display: none;">
        <h2>Digit-In-Noise Results</h2>
        <pre id="DIN_Results_Text_Display" style="margin-bottom:12px;"></pre>
    </div>
    <div id="test-area" style="display: none;">
      <p><em>Click "Play", then tell us if you can hear the sound. This helps check your hearing sensitivity at different tones.</em></p>
      <p id="question">Press play to start the test</p>
      <audio id="tone" controls></audio><br>
      <button onclick="recordResponse(true)">Yes</button>
      <button onclick="recordResponse(false)">No</button>
    </div>

    <div id="dbhl-test-area" style="display:none;">
      <p style="margin-bottom:12px; text-align: left;">Decibels Hearing Level, or dB HL, is a measure of the quietest sound you can hear relative to a person with normal hearing. If your dB HL is negative, then you hear better than average; if it's positive, then you hear worse than average. -10 to 15 dB is considered a normal range.</p>
      <p style="margin-bottom:12px; text-align: left;">This test will measure your dB HL by playing a 1 kHz tone for 1 second and seeing how you respond. If you can't hear the sound, then click "No", and it will become slightly louder. Once you're able to hear the tone, click "Yes" to end the test and receive your results.</p>
      <br>
      <div id="dbhl-controls" style="display:grid; grid-template-columns:max-content 110px 380px; grid-template-rows:auto auto; column-gap:48px; row-gap:8px; align-items:baseline; margin:8px 0;">
        <label for="dbhl-start" style="justify-self:start;">Start level (dBFS):</label>
        <input id="dbhl-start" type="number" value="-90" step="1" min="-120" max="-1" style="width:100px">
        <span id="dbhl-status" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-style:italic; padding-left:24px; align-self:baseline;"></span>
        <label for="dbhl-step" style="justify-self:start;">Step size (dB):</label>
        <input id="dbhl-step" type="number" value="2.0" step="0.5" min="0.1" max="20" style="width:100px">
        <div id="dbhl-replay-row" style="display:none; padding-left:24px;">
          <button id="dbhl-replay-btn" type="button" style="padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Replay</button>
        </div>
      </div>
      <br>
      <div id="dbhl-start-row" style="display:flex; justify-content:center; margin:12px 0;">
        <button id="dbhl-start-btn" type="button" style="padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Start Test</button>
      </div>
      <div id="dbhl-response-row" style="display:none; gap:12px; margin:12px 0;">
        <button id="dbhl-yes" style="background:#16a34a; color:#fff; padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Yes, I heard it</button>
        <button id="dbhl-no" style="background:#dc2626; color:#fff; padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">No, I didn't hear it</button>
      </div>
      <p id="dbhl-result" style="font-weight:600; margin-top:10px;"></p>
      <pre id="dbhl-log" style="background:#f8f9fa; padding:10px; border-radius:8px; max-height:200px; overflow:auto; margin-top:8px;"></pre>
    </div>

    <!-- Results will appear here -->
    <!-- Always-visible summary -->
    <section id="summary-section" style="display: none; margin-top: 2rem;">
    <h2>Hearing Test Summary</h2>
    <p id="summary-text" style="font-size: 1.1rem; padding: 1rem;"></p>
    </section>

    <!-- Expandable detailed section -->
    <details id="results-detail" style="display: none;">
    <summary><h3>See Detailed Results (Table & Audiogram)</h3></summary>

    <div style="margin-top: 1rem;">
        <table id="results-table">
        <tr><th>Frequency (Hz)</th><th>Volume (dB)</th><th>Result</th></tr>
        </table>

        <h3>Audiogram</h3>
        <canvas id="audiogramChart" width="600" height="400"></canvas>
    </div>
    </details>
  </div>

  <script src="script.js"></script>
</body>
</html>

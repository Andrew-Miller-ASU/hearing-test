<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hearing Test</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="container">
    <h1>Online Hearing Test</h1>
    <div id="calibration-page">
        <p id="calibration_page_text" style="margin-bottom:12px; text-align: left;">Welcome to the Online Hearing Test! First, let's ensure your audio devices are properly calibrated to your preferences. Click the "Test Volume" button below for the controls to play a sound. If you can hear the sound and it is an appropriate volume for you, click "Proceed To Test". Otherwise, please adjust your volume accordingly.</p>
        <button onclick="calibrationTest()">Test Volume</button>
        <button onclick="proceedToTest()">Proceed To Test</button>
        <audio id="calibrationTestAudio" style="display: none;" controls></audio><br>
    </div>
    <div id="din-calibration-page" style="display: none;">
        <p id="din_calibration_page_text" style="margin-bottom:12px; text-align: left;">Welcome to the Digit-In-Noise Calibration Page! Make sure that you're comfortable witht the audio. Click "Test Volume" and listen for the sound. You should adjust your audio devices as necessary before proceeding. When you are ready to move on to the test, click the "Proceed to Test" button.</p>
        <button id="din_calibration_test_volume_btn">Test Volume</button>
        <button id="din_calibration_proceed_to_test_btn">Proceed To Test</button>
        <audio id="dinCalibrationTestAudio" style="display: none;" controls></audio><br>
    </div>
    <div id="mode-select" style="display: none;">
       <h2>Choose Your Test Mode</h2>
       <button onclick="startTest('both')">üîä No Headphones</button>
       <button onclick="startTest('headphones')">üéß Headphones (Left & Right)</button>
       <button onclick="startDbHlTest()">dB HL Testing</button>
       <button onclick="DinCalibrationPage()">DIN Test</button>
       <button onclick="startFreqTest()">Frequency Range (Highest Only)</button>
       <button onclick="startTemporalGapTest()">Temporal Gap Detection </button>
    </div>
    <div id="test-area" style="display: none;">
      <p><em>Click "Play", then tell us if you can hear the sound. This helps check your hearing sensitivity at different tones.</em></p>
      <p id="question">Press play to start the test</p>
      <audio id="tone" controls></audio><br>
      <button onclick="recordResponse(true)">Yes</button>
      <button onclick="recordResponse(false)">No</button>
    </div>

    <!--- dB HL Test Area ---->
    
    <div id="dbhl-test-area" style="display:none;">
      <p style="margin-bottom:12px; text-align: left;">Decibels Hearing Level, or dB HL, is a measure of the quietest sound you can hear relative to a person with normal hearing. If your dB HL is negative, then you hear better than average; if it's positive, then you hear worse than average. -10 to 15 dB is considered a normal range.</p>
      <p style="margin-bottom:12px; text-align: left;">This test will measure your dB HL by playing a 1 kHz tone for 1 second and seeing how you respond. If you can't hear the sound, then click "No", and it will become slightly louder. Once you're able to hear the tone, click "Yes" to end the test and receive your results.</p>
      <br>
      <div id="dbhl-controls" style="display:grid; grid-template-columns:max-content 110px 380px; grid-template-rows:auto auto; column-gap:48px; row-gap:8px; align-items:baseline; margin:8px 0;">
        <label for="dbhl-start" style="justify-self:start;">Start level (dBFS):</label>
        <input id="dbhl-start" type="number" value="-90" step="1" min="-120" max="-1" style="width:100px">
        <span id="dbhl-status" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-style:italic; padding-left:24px; align-self:baseline;"></span>
        <label for="dbhl-step" style="justify-self:start;">Step size (dB):</label>
        <input id="dbhl-step" type="number" value="2.0" step="0.5" min="0.1" max="20" style="width:100px">
        <div id="dbhl-replay-row" style="display:none; padding-left:24px;">
          <button id="dbhl-replay-btn" type="button" style="padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Replay</button>
        </div>
      </div>
      <br>
      <div id="dbhl-start-row" style="display:flex; justify-content:center; margin:12px 0;">
        <button id="dbhl-start-btn" type="button" style="padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Start Test</button>
      </div>
      <div id="dbhl-response-row" style="display:none; gap:12px; margin:12px 0;">
        <button id="dbhl-yes" style="background:#16a34a; color:#fff; padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Yes, I heard it</button>
        <button id="dbhl-no" style="background:#dc2626; color:#fff; padding:8px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">No, I didn't hear it</button>
      </div>
      <p id="dbhl-result" style="font-weight:600; margin-top:10px;"></p>
      <pre id="dbhl-log" style="background:#f8f9fa; padding:10px; border-radius:8px; max-height:200px; overflow:auto; margin-top:8px;"></pre>
    </div>

    <!--- End dB HL Test Area ---->


    <!---- Digits-in-Noise Test Area ----> 

    <div id="din-test-area" style="display:none;">
      <p style="margin-bottom:12px; text-align:left;">The Digits-in-Noise Test will measure your ability to discern speech in the presence of background noise.</p>
      <p style="margin-bottom:12px; text-align:left;">Click "Play" to listen to the audio, then enter the digits you heard and click "Submit" to check your accuracy.</p>

      <div id="din-test-controls">
        <p id="din-round-display" style="margin-top:24px; margin-bottom:12px; text-align:center; font-weight:bold;"></p>
        <div style="justify-content:center; margin-top:20px; margin-bottom:20px;">
          <button id="din-play-btn">Play</button>
        </div>
        <input
          id="digits-input"
          type="text"
          inputmode="numeric"
          pattern="[0-9]{3}"
          maxlength="3"
          style="
            font-size:64px;
            font-family:monospace;
            text-align:center;
            border:3px solid #cbd5e1;
            border-radius:10px;
            padding:8px;
            padding-left:calc(8px + 1ch);
            width:6ch;
            letter-spacing:1ch;
        ">
        <div id="din-submit-quit-div" style="justify-content:center; gap:24px; margin-top:20px;">
          <button id="din-submit-btn">Submit</button>
          <button id="din-quit-btn">Quit</button>
        </div>
      </div>

      <section id="din-results-section" style="display:none; margin-top:24px;">
        <h3 style="margin-bottom:8px;">Digits-in-Noise Results</h3>
        <table id="din-results-table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:center; border-bottom:2px solid #e5e7eb; padding:8px;">Round #</th>
              <th style="text-align:center; border-bottom:2px solid #e5e7eb; padding:8px;">Digits played</th>
              <th style="text-align:center; border-bottom:2px solid #e5e7eb; padding:8px;">Digits heard</th>
              <th style="text-align:center; border-bottom:2px solid #e5e7eb; padding:8px;">Result</th>
              <th style="text-align:center; border-bottom:2px solid #e5e7eb; padding:8px;">SNR</th>
            </tr>
          </thead>
          <tbody id="din-results-tbody"></tbody>
        </table>
        <p id="din-best-snr-display" style="margin-top:12px; margin-bottom:12px; text-align:left; font-weight:bold;"></p>
        <div style="text-align: left;">
          <img src="charts/din_snr_norms.png" width="400">
        </div>
        <button id="din-restart-btn" onclick="resetDinTest()">Restart</button>
      </section>
    </div>
    
    
    <!--- End Digits-in-Noise Test Area -->
    
    
    
    <!-- Highest-Audible Frequency Test (frontend only; audio is a placeholder) -->
    <div id="freq-test-area" style="display:none;">
      <p style="margin-bottom:12px; text-align:left;">
        Click the "Play" button to play the sound, which will stop automatically after a few seconds.
        If you want to stop the sound before then, click the "Stop" button. 
        If you can still hear the tone, click the "Yes, I Can Still Hear It" button and the test will automatically prepare the next frequency for you.
        Click the "Play" button again when ready. If you need to manually change the frequency for any reason, you can do so with the "Increase" and "Decrease" buttons on the right of the box.
        When you reach the <strong>highest pitch you can still hear</strong>, click ‚ÄúNo, I Can't Hear It.‚Äù
        We recommend that you follow the "Next Suggested Frequency" listed below the box for a quick, yet efficient test, which will be done automatically with the "Yes, I Can Still Hear It" button. 
        However, you may follow your own judgement should you choose to. The test uses frequencies ranging from 2 kHz to 20 kHz.
      </p>

      <div style="display:flex; align-items:center; gap:12px; margin:12px 0;">
        <label for="freq-slider">Frequency:</label>
        <input
              id="freq-slider"
              type="number"
              min="2000"
              max="20000"
              step = "1000"
              value="1000"
              aria-label="Frequency (Hz)"
              onkeydown = "return false"
              oninput="updateFreqReadout()" 
              />
        <span id="freq-readout">1,000 Hz</span>
        <button id="freq-slider-increase-btn" onclick="eventListenerForFreqIncBtn()">Increase</button>
        <button id="freq-slider-decrease-btn" onclick="eventListenerForFreqDecBtn()">Decrease</button>
      </div>

      <div style="display:flex; gap:12px; margin:12px 0;">
        <button id="freq-play-btn" onclick="freqPlayPlaceholder()"
        style="background:#16a34a; color:#fff; padding:8px 12px; 
        border:none; border-radius:8px; font-weight:600; cursor:pointer;"
        >Play</button>
        <button id="freq-stop-btn" onclick="freqStopPlaceholder()"
        style="background:#dc2626; color:#fff; padding:8px 12px;
         border:none; border-radius:8px; font-weight:600; cursor:pointer;"
        >Stop</button>
        <span style="align-items:center; gap:12px; margin: 15px;" id="next_suggested_frequency"><b>Next Suggested Frequency Check: 3,000 Hz or 3 kHz</b></span>
      </div>

      <div style="display:flex; gap:12px; margin:12px 0;">
        <span style="align-items:center; gap:12px; margin: 15px;" id="freq_test_question_for_user"><b>Can you hear the frequency when you press "Play"? Check the sound status below.</b></span>
      </div>

      <div style="display:flex; gap:12px; margin:12px 0;">
        <button id="still-audible-btn" onclick="prepareFreqTestForNextFreq()"
        style="background:#16a34a; color:#fff; padding:8px 12px; 
        border:none; border-radius:8px; font-weight:600; cursor:pointer;"
        >Yes, I Can Still Hear It</button>
        <button id="mark-highest-btn" onclick="pinpointingExactFrequencyPage()" 
        style="background:#dc2626; color:#fff; padding:8px 12px;
         border:none; border-radius:8px; font-weight:600; cursor:pointer;"
         >No, I Can't Hear It</button>
        <button onclick="backToModesFromFreq()">Back to Modes</button>
      </div>

      <p id="freq-status" style="font-style:italic;"></p>
    </div>
    <!-- Pinpoint Highest Audible Page for Highest-Audible Frequency Test-->
    <div id="pinpoint_highest_audible_for_freq_test" style="display:none;">
      <p id="pinpoint_highest_audible_for_freq_test_instructions"
      style="margin-bottom:12px; text-align:left;"></p>
      <div style="display:flex; align-items:center; gap:12px; margin:12px 0;">
        <label for="freq-slider2">Frequency:</label>
        <input
              id="freq-slider2"
              type="number"
              min="2000"
              max="20000"
              step = "1000"
              value="1000"
              aria-label="Frequency (Hz)"
              onkeydown = "return false"
              oninput="updateFreqReadout2()" 
              />
        <span id="freq-readout2">1,000 Hz</span>
        <button id="freq-slider-increase-btn" onclick="eventListenerForFreqIncBtn()">Increase</button>
        <button id="freq-slider-decrease-btn" onclick="eventListenerForFreqDecBtn()">Decrease</button>
      </div>

      <div style="display:flex; gap:12px; margin:12px 0;">
        <button id="freq-play-btn" onclick="freqPlayPlaceholder()"
        style="background:#16a34a; color:#fff; padding:8px 12px; 
        border:none; border-radius:8px; font-weight:600; cursor:pointer;"
        >Play</button>
        <button id="freq-stop-btn" onclick="freqStopPlaceholder()"
        style="background:#dc2626; color:#fff; padding:8px 12px;
         border:none; border-radius:8px; font-weight:600; cursor:pointer;"
        >Stop</button>
        <span style="align-items:center; gap:12px; margin: 15px; font-weight:bold;" id="next_suggested_frequency2"><b></b></span>
      </div>
      <div style="display:flex; gap:12px; margin:12px 0;">
        <span style="align-items:center; gap:12px; margin: 15px;" id="freq_test_question_for_user"><b>Can you hear the frequency when you press "Play"? Check the sound status below.</b></span>
      </div>

      <div style="display:flex; gap:12px; margin:12px 0;">
        <button id="still-audible-btn" onclick="prepareFreqTestForNextFreq()"
        style="background:#16a34a; color:#fff; padding:8px 12px; 
        border:none; border-radius:8px; font-weight:600; cursor:pointer;"
        >Yes, I Can Still Hear It</button>
        <button id="mark-highest-btn" onclick="prepareForMarkHighestFrequency()" 
        style="background:#dc2626; color:#fff; padding:8px 12px;
         border:none; border-radius:8px; font-weight:600; cursor:pointer;"
         >No, I Can't Hear It</button>
        <button onclick="backToModesFromFreq()">Back to Modes</button>
      </div>

      <p id="freq-status2" style="font-style:italic;"></p>
    </div>
    <!-- End of Pinpoint Highest Audible Page for Highest Audible Frequency Test-->
    <!-- Results for the Highest-Audible Frequency Test -->
    <section id="freq-results-area" style="display:none; margin-top:24px;">
      <h3 style="margin-bottom:8px;">Frequency Test Result</h3>
      <p id="freq-result-text"></p>
      <figure id="freq-norms" class="norms-figure">
          <img
            src="charts/High_Frequency_Hearing_Test_Age_Norms.png"
            alt="Age norms for highest audible frequency"
            class="norms-img"
            loading="lazy"
            decoding="async"
          />
          <figcaption class="norms-cap">Age norms (highest audible frequency).</figcaption>
      </figure>
      <p id="freq-results-norms-chart-explanation">
        <strong>The typical highest frequency range for hearing loss is between 2 kHz and 8 kHz. 
        If you fall in this range, consult with a specialist. </strong>
        If you fall below the typical highest range for your demographic, 
        but can hear frequencies above 8 kHz, do not panic. While it might be a sign of frailty,
        either now or for the future, you are still above the range where hearing loss is typically
        found.
      </p>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button onclick="restartFreqTest()">Restart</button>
        <button onclick="backToModesFromFreq()">Back to Modes</button>
      </div>
    </section>

   <!-- End Highest-Audible Frequency Test -->

    <!-- Temporal Gap Detection  -->
   
    <div id="tg-test-area" style="display:none;">
      <p style="margin-bottom:12px; text-align:left;">
        You‚Äôll hear two short ‚Äúwhooshes.‚Äù One has a tiny pause. Choose the one with the pause.
        <br><span style="color:#64748b;">(Design preview ‚Äî audio not implemented yet.)</span>
      </p>

      <div id="tg-status" style="margin:8px 0; font-weight:600; text-align:center;">Ready</div>
      <div id="tg-progress" style="margin:8px 0; text-align:center;">Trial 0 / 12</div>
      <div style="width:100%; height:12px; border-radius:999px; background:#e5e7eb; overflow:hidden;">
        <div id="tg-progress-bar" style="height:100%; width:0%; background:#34d399;"></div>
      </div>

      <!-- START above the audios -->
     <div class="tg-top-controls">
        <button id="tg-start-btn" onclick="tgBeginDesign()"> Start Test</button>
        <button id="tg-replay-btn" onclick="tgReplayDesign()" disabled>Replay current trial</button>
     </div>

            <!-- Two ‚Äúaudio‚Äù panels left/right -->
      <div class="tg-grid">
        <div class="tg-audio">
          <div class="tg-audio-label">Audio 1 </div>
          <div class="tg-audio-visual" aria-hidden="true">A</div>
          <!-- selection under the audio -->
          <button id="tg-first-btn" class="big-choice" onclick="tgChoose(1)" disabled>First (1)</button>
        </div>

        <div class="tg-audio">
          <div class="tg-audio-label">Audio 2 </div>
          <div class="tg-audio-visual" aria-hidden="true">B</div>
          <!-- selection under the audio -->
          <button id="tg-second-btn" class="big-choice" onclick="tgChoose(2)" disabled>Second (2)</button>
        </div>
      </div>

  <!-- centered Back to Modes -->
  <div class="tg-bottom-controls">
    <button id="tg-back-btn" onclick="backToModesFromTG()">Back to Modes</button>
  </div>

  <section id="tg-results" style="display:none; margin-top:16px;">
    <h3 style="margin-bottom:6px;">Temporal Gap Result</h3>
    <p id="tg-result-summary">Your result will appear here when the audio engine is added.</p>
  </section>
</div>


    <!-- End Temporal Gap Detection (2AFC) -->
    <!-- Results will appear here -->
    <!-- Always-visible summary -->
    <section id="summary-section" style="display: none; margin-top: 2rem;">
    <h2>Hearing Test Summary</h2>
    <p id="summary-text" style="font-size: 1.1rem; padding: 1rem;"></p>
    </section>

    <!-- Expandable detailed section -->
    <details id="results-detail" style="display: none;">
    <summary><h3>See Detailed Results (Table & Audiogram)</h3></summary>

    <div style="margin-top: 1rem;">
        <table id="results-table">
        <tr><th>Frequency (Hz)</th><th>Volume (dB)</th><th>Result</th></tr>
        </table>

        <h3>Audiogram</h3>
        <canvas id="audiogramChart" width="600" height="400"></canvas>
    </div>
    </details>
  </div>

  <script src="script.js"></script>
</body>
</html>
